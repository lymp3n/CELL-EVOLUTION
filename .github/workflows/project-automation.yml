name: "ðŸ—‚ï¸ Sync Project Board with Issue Labels"

on:
  # Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹
  issues:
    types: [labeled, unlabeled, opened, closed, reopened]
  pull_request_target:
    types: [opened, closed, reopened, review_requested]
  # ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ð¹ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ (Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ)
  projectv2_item:
    types: [edited]
  # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: Ð´Ð»Ñ ÐµÐ¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸
  schedule:
    - cron: '0 9 * * 1'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00

permissions:
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  # 1. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: Issue â†’ ÐŸÑ€Ð¾ÐµÐºÑ‚ (Ð¿Ð¾ Ð¼ÐµÑ‚ÐºÐ°Ð¼)
  sync-issue-to-project:
    if: github.event_name == 'issues' && github.event.sender.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Debug - Show event info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Sender: ${{ github.event.sender.login }}"
          echo "Issue: #${{ github.event.issue.number }}"
          echo "State: ${{ github.event.issue.state }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"
      
      - name: ðŸ” Get project ID
        id: get_project
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!) {
              repository(owner:$owner, name:$repo) {
                projectsV2(first: 10, query: "CELL-EVOLUTION") {
                  nodes {
                    id
                    title
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" \
            --jq '.data.repository.projectsV2.nodes[0].id')
          
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "âŒ Project not found"
            exit 1
          fi
          
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Found project ID: $PROJECT_ID"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ¯ Determine target column from labels
        id: determine_column
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð»ÐµÐ¹Ð±Ð»Ð¾Ð²
          COLUMN_NAME="Backlog"  # ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ issue
          if [ "${{ github.event.issue.state }}" = "closed" ]; then
            COLUMN_NAME="Done"
          else
            # Ð˜Ñ‰ÐµÐ¼ Ð»ÐµÐ¹Ð±Ð» ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
            LABELS='${{ toJson(github.event.issue.labels) }}'
            
            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð»ÐµÐ¹Ð±Ð»Ñ‹ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ jq Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸)
            if echo "$LABELS" | jq -r '.[] | select(.name == "status: backlog") | .name' 2>/dev/null | grep -q "status: backlog"; then
              COLUMN_NAME="Backlog"
            elif echo "$LABELS" | jq -r '.[] | select(.name == "status: ready") | .name' 2>/dev/null | grep -q "status: ready"; then
              COLUMN_NAME="Ready"
            elif echo "$LABELS" | jq -r '.[] | select(.name == "status: in progress") | .name' 2>/dev/null | grep -q "status: in progress"; then
              COLUMN_NAME="In Progress"
            elif echo "$LABELS" | jq -r '.[] | select(.name == "status: in review") | .name' 2>/dev/null | grep -q "status: in review"; then
              COLUMN_NAME="In Review"
            elif echo "$LABELS" | jq -r '.[] | select(.name == "status: testing") | .name' 2>/dev/null | grep -q "status: testing"; then
              COLUMN_NAME="Testing"
            elif echo "$LABELS" | jq -r '.[] | select(.name == "status: done") | .name' 2>/dev/null | grep -q "status: done"; then
              COLUMN_NAME="Done"
            fi
          fi
          
          echo "COLUMN_NAME=$COLUMN_NAME" >> $GITHUB_OUTPUT
          echo "Determined column: $COLUMN_NAME"
      
      - name: ðŸ“Œ Get or create project item
        id: get_item
        run: |
          # Ð˜Ñ‰ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÑƒ
          ITEM_ID=$(gh api graphql -f query='
            query($project:ID!, $issue:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 50) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          number
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            -f issue="${{ github.event.issue.node_id }}" \
            --jq '.data.node.items.nodes[] | select(.content.id == env.issue) | .id' 2>/dev/null || true)
          
          if [ -z "$ITEM_ID" ]; then
            # ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð½ÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ
            echo "Creating new project item..."
            ITEM_ID=$(gh api graphql -f query='
              mutation($project:ID!, $issue:ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $issue}) {
                  item {
                    id
                  }
                }
              }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
              -f issue="${{ github.event.issue.node_id }}" \
              --jq '.data.addProjectV2ItemById.item.id')
            
            echo "Created new item: $ITEM_ID"
          else
            echo "Found existing item: $ITEM_ID"
          fi
          
          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ—‚ï¸ Move to target column
        if: steps.get_item.outputs.ITEM_ID != ''
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ID ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸
          COLUMN_ID=$(gh api graphql -f query='
            query($project:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            --jq '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == env.column) | .id' \
            --arg column "${{ steps.determine_column.outputs.COLUMN_NAME }}")
          
          if [ -z "$COLUMN_ID" ]; then
            echo "âŒ Column '${{ steps.determine_column.outputs.COLUMN_NAME }}' not found"
            echo "Available columns:"
            gh api graphql -f query='
              query($project:ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          name
                          options {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
              --jq '.data.node.fields.nodes[] | select(.name == "Status") | .options[].name' | tr '\n' ', '
            exit 1
          fi
          
          echo "Moving to column: ${{ steps.determine_column.outputs.COLUMN_NAME }} (ID: $COLUMN_ID)"
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $status:ID!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: "status"
                value: {
                  singleSelectOptionId: $status
                }
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            -f item="${{ steps.get_item.outputs.ITEM_ID }}" \
            -f status="$COLUMN_ID"
          
          echo "âœ… Successfully moved issue #${{ github.event.issue.number }} to ${{ steps.determine_column.outputs.COLUMN_NAME }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: ÐŸÑ€Ð¾ÐµÐºÑ‚ â†’ Issue (Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸ÑŽ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº)
  sync-project-to-issue:
    if: github.event_name == 'projectv2_item' && github.event.action == 'edited' && github.event.sender.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Debug - Show project event info
        run: |
          echo "Project ID: ${{ github.event.projectv2_item.project_node_id }}"
          echo "Item ID: ${{ github.event.projectv2_item.node_id }}"
          echo "Sender: ${{ github.event.sender.login }}"
      
      - name: ðŸ” Get project item details
        id: get_item
        run: |
          ITEM_DETAILS=$(gh api graphql -f query='
            query($item: ID!) {
              node(id: $item) {
                ... on ProjectV2Item {
                  content {
                    ... on Issue {
                      id
                      number
                      title
                    }
                  }
                  fieldValueByName(name: "Status") {
                    ... on ProjectV2ItemFieldSingleSelectValue {
                      name
                    }
                  }
                }
              }
            }' -f item="${{ github.event.projectv2_item.node_id }}" --silent)
          
          ISSUE_NUMBER=$(echo "$ITEM_DETAILS" | jq -r '.data.node.content.number // empty')
          ISSUE_TITLE=$(echo "$ITEM_DETAILS" | jq -r '.data.node.content.title // empty')
          STATUS_NAME=$(echo "$ITEM_DETAILS" | jq -r '.data.node.fieldValueByName.name // empty')
          
          if [ -z "$ISSUE_NUMBER" ] || [ "$ISSUE_NUMBER" = "null" ]; then
            echo "âš ï¸ Item content is not an Issue, skipping."
            echo "IS_ISSUE=false" >> $GITHUB_OUTPUT
          else
            echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          fi
          
          if [ -n "$STATUS_NAME" ] && [ "$STATUS_NAME" != "null" ]; then
            echo "STATUS_NAME=$STATUS_NAME" >> $GITHUB_OUTPUT
            echo "Current status in project: $STATUS_NAME"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ¯ Map project status to issue label
        id: map_label
        if: steps.get_item.outputs.IS_ISSUE != 'false' && steps.get_item.outputs.STATUS_NAME != ''
        run: |
          STATUS_NAME="${{ steps.get_item.outputs.STATUS_NAME }}"
          
          case "$STATUS_NAME" in
            "Backlog")
              NEW_LABEL="status: backlog"
              ;;
            "Ready")
              NEW_LABEL="status: ready"
              ;;
            "In Progress")
              NEW_LABEL="status: in progress"
              ;;
            "In Review")
              NEW_LABEL="status: in review"
              ;;
            "Testing")
              NEW_LABEL="status: testing"
              ;;
            "Done")
              NEW_LABEL="status: done"
              ;;
            *)
              NEW_LABEL=""
              echo "â„¹ï¸ No label mapping for status: $STATUS_NAME"
              ;;
          esac
          
          if [ -n "$NEW_LABEL" ]; then
            echo "NEW_LABEL=$NEW_LABEL" >> $GITHUB_OUTPUT
            echo "Mapped to label: $NEW_LABEL"
          fi
      
      - name: ðŸ·ï¸ Update issue labels
        if: steps.map_label.outputs.NEW_LABEL != ''
        run: |
          ISSUE_NUM="${{ steps.get_item.outputs.ISSUE_NUMBER }}"
          NEW_LABEL="${{ steps.map_label.outputs.NEW_LABEL }}"
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¼ÐµÑ‚ÐºÐ¸
          CURRENT_LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð°ÐºÐ°Ñ Ð¼ÐµÑ‚ÐºÐ°
          if echo "$CURRENT_LABELS" | grep -q "^$NEW_LABEL$"; then
            echo "âœ… Issue already has label: $NEW_LABEL, skipping."
            exit 0
          fi
          
          echo "Updating issue #$ISSUE_NUM labels..."
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ-Ð¼ÐµÑ‚ÐºÐ¸
          for label in $CURRENT_LABELS; do
            if [[ "$label" == status:* ]]; then
              echo "Removing old status label: $label"
              gh issue edit "$ISSUE_NUM" --remove-label "$label" 2>/dev/null || true
            fi
          done
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð¼ÐµÑ‚ÐºÑƒ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
          echo "Adding new status label: $NEW_LABEL"
          gh issue edit "$ISSUE_NUM" --add-label "$NEW_LABEL"
          
          # Ð•ÑÐ»Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ "Done" Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ, Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ issue
          if [ "$NEW_LABEL" = "status: done" ]; then
            echo "Closing issue #$ISSUE_NUM (moved to Done)"
            gh issue edit "$ISSUE_NUM" --state closed
          # Ð•ÑÐ»Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ðµ "Done", Ð½Ð¾ issue Ð·Ð°ÐºÑ€Ñ‹Ñ‚ - Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼
          elif [ "$NEW_LABEL" != "status: done" ]; then
            ISSUE_STATE=$(gh issue view "$ISSUE_NUM" --json state --jq '.state' 2>/dev/null || echo "open")
            if [ "$ISSUE_STATE" = "CLOSED" ]; then
              echo "Reopening issue #$ISSUE_NUM (moved from Done)"
              gh issue edit "$ISSUE_NUM" --state open
            fi
          fi
          
          echo "âœ… Successfully updated issue #$ISSUE_NUM"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 3. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ PR â†’ Issue
  sync-pr-to-project:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“‹ Debug PR info
        run: |
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "State: ${{ github.event.pull_request.state }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"
          echo "Title: ${{ github.event.pull_request.title }}"
      
      - name: ðŸ” Find related issue
        id: find_issue
        run: |
          # Ð˜Ñ‰ÐµÐ¼ issue, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² PR
          ISSUE_NUMBERS=()
          
          # Ð˜Ñ‰ÐµÐ¼ Ð² Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐµ
          if [[ "${{ github.event.pull_request.title }}" =~ #[0-9]+ ]]; then
            ISSUE_NUMBERS+=($(echo "${{ github.event.pull_request.title }}" | grep -o '#[0-9]\+' | sed 's/#//'))
          fi
          
          # Ð˜Ñ‰ÐµÐ¼ Ð² Ñ‚ÐµÐ»Ðµ PR
          if [[ "${{ github.event.pull_request.body }}" =~ #[0-9]+ ]]; then
            ISSUE_NUMBERS+=($(echo "${{ github.event.pull_request.body }}" | grep -o '#[0-9]\+' | sed 's/#//'))
          fi
          
          # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¸ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€
          if [ ${#ISSUE_NUMBERS[@]} -gt 0 ]; then
            UNIQUE_ISSUES=($(printf "%s\n" "${ISSUE_NUMBERS[@]}" | sort -u))
            echo "Found issues: ${UNIQUE_ISSUES[@]}"
            echo "ISSUE_NUMBERS=${UNIQUE_ISSUES[0]}" >> $GITHUB_OUTPUT
          else
            echo "No related issues found in PR title/body"
            echo "ISSUE_NUMBERS=" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ¯ Update issue status based on PR
        if: steps.find_issue.outputs.ISSUE_NUMBERS != ''
        run: |
          ISSUE_NUM="${{ steps.find_issue.outputs.ISSUE_NUMBERS }}"
          
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            NEW_STATUS="status: testing"
            echo "âœ… PR merged, moving issue #$ISSUE_NUM to testing"
          elif [ "${{ github.event.pull_request.state }}" = "closed" ]; then
            NEW_STATUS="status: in progress"
            echo "ðŸ”„ PR closed without merge, moving issue #$ISSUE_NUM back to in progress"
          else
            # PR Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚
            echo "PR opened, checking reviews..."
            REVIEWERS=$(gh pr view "${{ github.event.pull_request.number }}" --json reviews --jq '.reviews[].author.login' 2>/dev/null || true)
            if [ -n "$REVIEWERS" ]; then
              NEW_STATUS="status: in review"
              echo "ðŸ‘€ PR has reviews, moving issue #$ISSUE_NUM to in review"
            else
              NEW_STATUS="status: in progress"
              echo "âœï¸ PR opened, issue #$ISSUE_NUM stays in progress"
            fi
          fi
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»ÐµÐ¹Ð±Ð»Ñ‹ issue
          CURRENT_LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '.labels[].name' 2>/dev/null || true)
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ-Ð»ÐµÐ¹Ð±Ð»Ñ‹
          for label in $CURRENT_LABELS; do
            if [[ "$label" == status:* ]]; then
              echo "Removing label: $label"
              gh issue edit "$ISSUE_NUM" --remove-label "$label" 2>/dev/null || true
            fi
          done
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
          echo "Adding label: $NEW_STATUS"
          gh issue edit "$ISSUE_NUM" --add-label "$NEW_STATUS"
          
          echo "âœ… Updated issue #$ISSUE_NUM to $NEW_STATUS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 4. Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
  weekly-cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¹ Clean up old 'Done' items
        run: |
          echo "Starting weekly cleanup of old Done items..."
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
          PROJECT_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!) {
              repository(owner:$owner, name:$repo) {
                projectsV2(first: 1, query: "CELL-EVOLUTION") {
                  nodes {
                    id
                    title
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" \
            --jq '.data.repository.projectsV2.nodes[0].id')
          
          echo "Project ID: $PROJECT_ID"
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² ÐºÐ¾Ð»Ð¾Ð½ÐºÐµ "Done", ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹ Ð±Ð¾Ð»ÐµÐµ 2 Ð½ÐµÐ´ÐµÐ»ÑŒ Ð½Ð°Ð·Ð°Ð´
          gh api graphql -f query='
            query($project:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                      content {
                        ... on Issue {
                          number
                          closedAt
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID" \
            --jq '.data.node.items.nodes[] | select(.fieldValues.nodes[].name == "Done") | select(.content.closedAt != null) | .id + "|" + .content.closedAt + "|" + .content.number' \
            | while IFS='|' read -r ITEM_ID CLOSED_AT ISSUE_NUM; do
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð»Ð¸ Ð±Ð¾Ð»ÐµÐµ 2 Ð½ÐµÐ´ÐµÐ»ÑŒ
              if [ -n "$CLOSED_AT" ] && [ "$CLOSED_AT" != "null" ]; then
                CLOSED_DATE=$(date -d "$CLOSED_AT" +%s 2>/dev/null || date +%s)
                TWO_WEEKS_AGO=$(date -d "14 days ago" +%s)
                
                if [ "$CLOSED_DATE" -lt "$TWO_WEEKS_AGO" ]; then
                  echo "Removing item for issue #$ISSUE_NUM closed at $CLOSED_AT (more than 2 weeks ago)"
                  gh api graphql -f query='
                    mutation($project:ID!, $item:ID!) {
                      deleteProjectV2Item(input: {projectId: $project, itemId: $item}) {
                        deletedItemId
                      }
                    }' -f project="$PROJECT_ID" -f item="$ITEM_ID" 2>/dev/null || echo "Failed to delete item $ITEM_ID"
                else
                  echo "Keeping issue #$ISSUE_NUM (closed at $CLOSED_AT)"
                fi
              fi
            done
          
          echo "âœ… Weekly cleanup completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
