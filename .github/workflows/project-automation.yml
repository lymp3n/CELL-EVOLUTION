name: Project Board Automation
on:
  issues:
    types: [opened, labeled, closed]

jobs:
  sync-labels-to-columns:
    runs-on: ubuntu-latest
    steps:
      - name: Move issue based on status label
        uses: actions/github-script@v6
        env:
          PROJECT_NUMBER: 1 # ЗАМЕНИТЕ ЭТО НАСТОЯЩИМ ID!
        with:
          script: |
            const { issue } = context.payload;
            const projectNumber = process.env.PROJECT_NUMBER;
            
            // Соответствие лейблов статуса и названий колонок в Канбане
            const statusToColumn = {
              'status: backlog': 'Backlog',
              'status: ready': 'Ready',
              'status: in progress': 'In progress',
              'status: in review': 'In review',
              'status: testing': 'Testing',
              'status: done': 'Done'
            };

            // 1. Находим проект
            const projects = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const project = projects.data.find(p => p.number == projectNumber);
            if (!project) { console.log(`Проект #${projectNumber} не найден.`); return; }

            // 2. Находим все колонки проекта
            const columns = await github.rest.projects.listColumns({
              project_id: project.id,
            });

            // 3. Определяем целевую колонку на основе лейблов issue
            let targetColumnName = 'Backlog'; // По умолчанию
            const statusLabels = issue.labels.filter(l => l.name.startsWith('status:'));
            if (statusLabels.length > 0) {
              const matchedColumn = statusToColumn[statusLabels[0].name];
              if (matchedColumn) targetColumnName = matchedColumn;
            }
            if (issue.state === 'closed') targetColumnName = 'Done';

            const targetColumn = columns.data.find(c => c.name === targetColumnName);
            if (!targetColumn) { console.log(`Колонка "${targetColumnName}" не найдена.`); return; }

            // 4. Ищем существующую карточку issue
            const cards = await github.rest.projects.listCards({
              column_id: targetColumn.id,
            });
            const existingCard = cards.data.find(c => c.content_url && c.content_url.endsWith(`/issues/${issue.number}`));

            // 5. Если карточки нет в нужной колонке — создаем или перемещаем её
            if (!existingCard) {
              // Проверяем все колонки, может карточка уже есть в другой
              for (const column of columns.data) {
                const columnCards = await github.rest.projects.listCards({ column_id: column.id });
                const cardInOtherColumn = columnCards.data.find(c => c.content_url && c.content_url.endsWith(`/issues/${issue.number}`));
                if (cardInOtherColumn) {
                  // Перемещаем в целевую колонку
                  await github.rest.projects.moveCard({
                    card_id: cardInOtherColumn.id,
                    position: 'bottom',
                    column_id: targetColumn.id
                  });
                  console.log(`Перемещена карточка для issue #${issue.number} в колонку "${targetColumnName}".`);
                  return;
                }
              }
              // Если карточки нигде нет — создаем новую
              await github.rest.projects.createCard({
                column_id: targetColumn.id,
                content_id: issue.id,
                content_type: 'Issue'
              });
              console.log(`Создана новая карточка для issue #${issue.number} в колонке "${targetColumnName}".`);
            }
