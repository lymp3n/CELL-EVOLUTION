name: "üóÇÔ∏è Sync Project Board with Issue Labels"
on:
  issues:
    types: [labeled, unlabeled, opened, closed, reopened]
  pull_request_target:
    types: [opened, closed, reopened, review_requested]

permissions:
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  sync-issue-to-project:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: üìã Debug - Show event info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Issue: #${{ github.event.issue.number }}"
          echo "State: ${{ github.event.issue.state }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"
      
      - name: üîç Get project ID
        id: get_project
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!) {
              repository(owner:$owner, name:$repo) {
                projectsV2(first: 10, query: "CELL-EVOLUTION") {
                  nodes {
                    id
                    title
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" \
            --jq '.data.repository.projectsV2.nodes[0].id')
          
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üéØ Determine target column from labels
        id: determine_column
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–µ–π–±–ª–æ–≤
          COLUMN_NAME="Backlog"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å issue
          if [ "${{ github.event.issue.state }}" = "closed" ]; then
            COLUMN_NAME="Done"
          else
            # –ò—â–µ–º –ª–µ–π–±–ª —Å—Ç–∞—Ç—É—Å–∞
            STATUS_LABELS="status: ready|status: in progress|status: in review|status: testing"
            
            # –ü–æ–ª—É—á–∞–µ–º –ª–µ–π–±–ª—ã –∏–∑ —Å–æ–±—ã—Ç–∏—è
            LABELS='${{ toJson(github.event.issue.labels) }}'
            
            # –ü–∞—Ä—Å–∏–º –ª–µ–π–±–ª—ã (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
            if echo "$LABELS" | grep -q "status: ready"; then
              COLUMN_NAME="Ready"
            elif echo "$LABELS" | grep -q "status: in progress"; then
              COLUMN_NAME="In Progress"
            elif echo "$LABELS" | grep -q "status: in review"; then
              COLUMN_NAME="In Review"
            elif echo "$LABELS" | grep -q "status: testing"; then
              COLUMN_NAME="Testing"
            elif echo "$LABELS" | grep -q "status: done"; then
              COLUMN_NAME="Done"
            fi
          fi
          
          echo "COLUMN_NAME=$COLUMN_NAME" >> $GITHUB_OUTPUT
          echo "Determined column: $COLUMN_NAME"
      
      - name: üìå Get or create project item
        id: get_item
        run: |
          # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
          ITEM_ID=$(gh api graphql -f query='
            query($project:ID!, $issue:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 20) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                          number
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            -f issue="${{ github.event.issue.node_id }}" \
            --jq '.data.node.items.nodes[] | select(.content.id == env.issue) | .id' 2>/dev/null || true)
          
          if [ -z "$ITEM_ID" ]; then
            # –ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
            echo "Creating new project item..."
            ITEM_ID=$(gh api graphql -f query='
              mutation($project:ID!, $issue:ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $issue}) {
                  item {
                    id
                  }
                }
              }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
              -f issue="${{ github.event.issue.node_id }}" \
              --jq '.data.addProjectV2ItemById.item.id')
            
            echo "Created new item: $ITEM_ID"
          else
            echo "Found existing item: $ITEM_ID"
          fi
          
          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üóÇÔ∏è Move to target column
        if: steps.get_item.outputs.ITEM_ID != ''
        run: |
          # –ü–æ–ª—É—á–∞–µ–º ID –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∏–º–µ–Ω–∏
          COLUMN_ID=$(gh api graphql -f query='
            query($project:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            --jq '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == env.column) | .id' \
            --arg column "${{ steps.determine_column.outputs.COLUMN_NAME }}")
          
          if [ -z "$COLUMN_ID" ]; then
            echo "‚ùå Column '${{ steps.determine_column.outputs.COLUMN_NAME }}' not found"
            exit 1
          fi
          
          echo "Moving to column: ${{ steps.determine_column.outputs.COLUMN_NAME }} (ID: $COLUMN_ID)"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $status:ID!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: "status"
                value: {
                  singleSelectOptionId: $status
                }
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f project="${{ steps.get_project.outputs.PROJECT_ID }}" \
            -f item="${{ steps.get_item.outputs.ITEM_ID }}" \
            -f status="$COLUMN_ID"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sync-pr-to-project:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: üìã Debug PR info
        run: |
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "State: ${{ github.event.pull_request.state }}"
          echo "Merged: ${{ github.event.pull_request.merged }}"
      
      - name: üîç Find related issue
        id: find_issue
        run: |
          # –ò—â–µ–º issue, —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ PR
          ISSUE_NUMBERS=()
          
          # –ò—â–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
          if [[ "${{ github.event.pull_request.title }}" =~ #[0-9]+ ]]; then
            ISSUE_NUMBERS+=($(echo "${{ github.event.pull_request.title }}" | grep -o '#[0-9]\+' | sed 's/#//'))
          fi
          
          # –ò—â–µ–º –≤ —Ç–µ–ª–µ PR
          if [[ "${{ github.event.pull_request.body }}" =~ #[0-9]+ ]]; then
            ISSUE_NUMBERS+=($(echo "${{ github.event.pull_request.body }}" | grep -o '#[0-9]\+' | sed 's/#//'))
          fi
          
          # –ò—â–µ–º –≤ –∫–æ–º–º–∏—Ç–∞—Ö
          COMMIT_MSG=$(gh pr view "${{ github.event.pull_request.number }}" --json commits --jq '.commits[].message' 2>/dev/null || true)
          if [[ "$COMMIT_MSG" =~ #[0-9]+ ]]; then
            ISSUE_NUMBERS+=($(echo "$COMMIT_MSG" | grep -o '#[0-9]\+' | sed 's/#//'))
          fi
          
          # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
          UNIQUE_ISSUES=($(echo "${ISSUE_NUMBERS[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
          
          if [ ${#UNIQUE_ISSUES[@]} -gt 0 ]; then
            echo "Found issues: ${UNIQUE_ISSUES[@]}"
            echo "ISSUE_NUMBERS=${UNIQUE_ISSUES[0]}" >> $GITHUB_OUTPUT
          else
            echo "No related issues found"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üéØ Update issue status based on PR
        if: steps.find_issue.outputs.ISSUE_NUMBERS != ''
        run: |
          ISSUE_NUM="${{ steps.find_issue.outputs.ISSUE_NUMBERS }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            NEW_STATUS="status: testing"
            echo "PR merged, moving issue #$ISSUE_NUM to testing"
          elif [ "${{ github.event.pull_request.state }}" = "closed" ]; then
            NEW_STATUS="status: in progress"
            echo "PR closed without merge, moving issue #$ISSUE_NUM back to in progress"
          else
            # PR –æ—Ç–∫—Ä—ã—Ç
            REVIEWERS=$(gh pr view "${{ github.event.pull_request.number }}" --json reviews --jq '.reviews[].author.login' 2>/dev/null || true)
            if [ -n "$REVIEWERS" ]; then
              NEW_STATUS="status: in review"
              echo "PR has reviews, moving issue #$ISSUE_NUM to in review"
            else
              NEW_STATUS="status: in progress"
              echo "PR opened, issue #$ISSUE_NUM stays in progress"
            fi
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–π–±–ª—ã issue
          CURRENT_LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '.labels[].name' 2>/dev/null || true)
          
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å-–ª–µ–π–±–ª—ã
          for label in $CURRENT_LABELS; do
            if [[ "$label" == status:* ]]; then
              echo "Removing label: $label"
              gh issue edit "$ISSUE_NUM" --remove-label "$label" || true
            fi
          done
          
          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
          echo "Adding label: $NEW_STATUS"
          gh issue edit "$ISSUE_NUM" --add-label "$NEW_STATUS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  weekly-cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: üßπ Clean up old 'Done' items
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç
          PROJECT_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!) {
              repository(owner:$owner, name:$repo) {
                projectsV2(first: 1, query: "CELL-EVOLUTION") {
                  nodes {
                    id
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" \
            --jq '.data.repository.projectsV2.nodes[0].id')
          
          # –ù–∞—Ö–æ–¥–∏–º –∑–∞–¥–∞—á–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ "Done", –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –±–æ–ª–µ–µ 2 –Ω–µ–¥–µ–ª—å –Ω–∞–∑–∞–¥
          gh api graphql -f query='
            query($project:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                      content {
                        ... on Issue {
                          number
                          closedAt
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID" \
            --jq '.data.node.items.nodes[] | select(.fieldValues.nodes[].name == "Done") | select(.content.closedAt != null) | .id + "|" + .content.closedAt' \
            | while IFS='|' read -r ITEM_ID CLOSED_AT; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –±–æ–ª–µ–µ 2 –Ω–µ–¥–µ–ª—å
              CLOSED_DATE=$(date -d "$CLOSED_AT" +%s)
              TWO_WEEKS_AGO=$(date -d "14 days ago" +%s)
              
              if [ "$CLOSED_DATE" -lt "$TWO_WEEKS_AGO" ]; then
                echo "Removing item closed at $CLOSED_AT (more than 2 weeks ago)"
                gh api graphql -f query='
                  mutation($project:ID!, $item:ID!) {
                    deleteProjectV2Item(input: {projectId: $project, itemId: $item}) {
                      deletedItemId
                    }
                  }' -f project="$PROJECT_ID" -f item="$ITEM_ID"
              fi
            done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
