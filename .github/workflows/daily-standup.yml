name: Daily Standup Reminder
on:
  schedule:
    # –ö–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å –≤ 9:00 –ø–æ –ú–æ—Å–∫–≤–µ
    - cron: '0 6 * * 1-5'
  workflow_dispatch:

jobs:
  standup-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Generate standup report
        uses: actions/github-script@v6
        with:
          script: |
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ issue, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              assignee: '*' // –í—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º
            const assignments = {};
            for (const issue of issues.data) {
              for (const assignee of issue.assignees) {
                if (!assignments[assignee.login]) {
                  assignments[assignee.login] = [];
                }
                assignments[assignee.login].push({
                  number: issue.number,
                  title: issue.title,
                  url: issue.html_url,
                  labels: issue.labels.map(l => l.name)
                });
              }
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            const date = new Date().toLocaleDateString('ru-RU');
            let report = `# üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å—Ç–µ–Ω–¥–∞–ø ${date}\n\n`;
            report += `_–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏_\n\n`;
            
            for (const [username, tasks] of Object.entries(assignments)) {
              report += `## @${username}\n`;
              
              const inProgress = tasks.filter(t => t.labels.includes('status: in progress'));
              const inReview = tasks.filter(t => t.labels.includes('status: in review'));
              const testing = tasks.filter(t => t.labels.includes('status: testing'));
              
              if (inProgress.length > 0) {
                report += `**–í —Ä–∞–±–æ—Ç–µ:**\n`;
                inProgress.forEach(task => {
                  report += `- ${task.title} [#${task.number}](${task.url})\n`;
                });
              }
              
              if (inReview.length > 0) {
                report += `**–ù–∞ —Ä–µ–≤—å—é:**\n`;
                inReview.forEach(task => {
                  report += `- ${task.title} [#${task.number}](${task.url})\n`;
                });
              }
              
              if (testing.length > 0) {
                report += `**–í —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:**\n`;
                testing.forEach(task => {
                  report += `- ${task.title} [#${task.number}](${task.url})\n`;
                });
              }
              
              report += `\n**–í–æ–ø—Ä–æ—Å—ã:**\n`;
              report += `1. –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤—á–µ—Ä–∞?\n`;
              report += `2. –ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å–µ–≥–æ–¥–Ω—è?\n`;
              report += `3. –ï—Å—Ç—å –ª–∏ –±–ª–æ–∫–µ—Ä—ã?\n\n`;
            }
            
            // –°–æ–∑–¥–∞–µ–º issue –¥–ª—è —Å—Ç–µ–Ω–¥–∞–ø–∞
            const standupIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìÖ –°—Ç–µ–Ω–¥–∞–ø ${date}`,
              body: report,
              labels: ['standup', 'automated']
            });
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const participants = Object.keys(assignments).map(u => `@${u}`).join(' ');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: standupIssue.data.number,
              body: `${participants}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö!`
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ–µ–∫—Ç
            await github.rest.projects.createCard({
              column_id: process.env.STANDUP_COLUMN_ID, // ID –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–µ–Ω–¥–∞–ø–æ–≤
              content_id: standupIssue.data.id,
              content_type: 'Issue'
            });
